name: Release

on:
  pull_request_target:
    types:
      - closed
    branches:
      - master
      - main

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
  PULL_REQUEST_BRANCH: ${{ github.head_ref }}
  BRANCH: ${{ github.event.pull_request.head.ref }}
  REGISTRY: ghcr.io
  IMAGE_NAME: "ghcr.io/${{ github.repository }}"
  RELEASE: true

jobs:
  config:
    if: github.triggering_actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    outputs:
      go-version: ${{ fromJson(steps.config.outputs.config).go-version }}
      deploy-pull-request: ${{ fromJson(steps.config.outputs.config).deploy.pull-request }}
      deploy-sign-docker-image: ${{ fromJson(steps.config.outputs.config).deploy.sign-docker-image }}
      deploy-release-images: ${{ steps.deploy-images-profiles.outputs.images }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ env.BRANCH }}
      - name: Read config
        id: config
        run: echo "config=$(jq -M -c '.' ./.github/workflow-config.json)" >> $GITHUB_OUTPUT
      - name: List post-release profiles
        id: deploy-images-profiles
        run: echo "images=$(jq -c -M '.deploy."release-images"' .github/workflow-config.json)" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs:
      - config
    outputs:
      version: ${{ steps.version.outputs.version }}
      oracle-version: ${{ steps.version.outputs.oracle-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ env.BRANCH }}

      - name: Setup Golang
        uses: actions/setup-go@v3
        with:
          go-version: ${{ needs.config.outputs.go-version }}

      - name: Get makefile versions
        id: version
        run: |
          oracle_version=$(make oracle-version)
          version=$(make version)
          echo "oracle-version=$oracle_version" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Setup instantclient cache
        uses: actions/cache@v3
        env:
          cache-name: cache-instantclient-rpm
          cache-version: ${{ steps.version.outputs.oracle-version }}
        with:
          path: |
            ./oracle-instantclient-*.rpm
            ./oci8.pc
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ env.cache-version }}-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-${{ env.cache-version }}-

      - name: Install dependencies
        run: |
          make oci.pc prereq

      - name: Setup Golang cache
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build artifact
        run: make go-build

      - name: Run test
        run: make go-test

      - name: Go lint
        continue-on-error: true
        uses: golangci/golangci-lint-action@v3
        with:
          args: --issues-exit-code=0
          skip-pkg-cache: true
          skip-build-cache: true

      - name: Package artifact
        run: |
          mv dist/*.tar.gz application.tar.gz

      - name: Upload build output
        uses: actions/upload-artifact@v3
        with:
          name: application
          path: "./application.tar.gz"

      - name: Upload test coverage
        uses: actions/upload-artifact@v3
        with:
          name: test-coverage
          path: "./test-coverage.out"

  release:
    runs-on: ubuntu-latest
    needs:
      - config
      - build
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ env.BRANCH }}

      - name: Set release version
        id: version
        run: echo "version=${{ needs.build.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: application
          path: "."

      - name: Unpack artifact
        run: tar -xzvf application.tar.gz

      - name: generate changelog
        continue-on-error: true
        uses: metcalfc/changelog-generator@v4.0.1
        id: changelog
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release
        uses: softprops/action-gh-release@v1
        id: create-release
        with:
          name: Release ${{ steps.version.outputs.version }}
          tag_name: ${{ steps.version.outputs.version }}
          token: ${{ secrets.GITHUB_TOKEN }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false

      - name: Upload release assets
        uses: actions/upload-release-asset@v1
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: ./application.tar.gz
          asset_name: ${{ github.event.repository.name }}.tar.gz
          asset_content_type: application/gzip

  deploy:
    runs-on: ubuntu-latest
    if: ${{ !failure() && needs.release.result == 'success' }}
    needs:
      - config
      - build
      - release
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ env.BRANCH }}

      - name: Setup instantclient cache
        uses: actions/cache@v3
        env:
          cache-name: cache-instantclient-rpm
          cache-version: ${{ needs.build.outputs.oracle-version }}
        with:
          path: |
            ./oracle-instantclient-*.rpm
            ./oci8.pc
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ env.cache-version }}-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-${{ env.cache-version }}-

      - name: Install dependencies
        run: |
          make oci.pc download-rpms

      - name: Build image
        env:
          VERSION: "${{ needs.release.outputs.version }}"
        run: make ubuntu-image

      - name: Log in to registry
        # This is where you will update the personal access token to GITHUB_TOKEN
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u $ --password-stdin

      - name: Push image
        id: docker-meta
        env:
          VERSION: "${{ needs.release.outputs.version }}"
        run: |
          make push-ubuntu-image
          echo "image-id=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "image-version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup cosign
        if: ${{ needs.config.outputs.deploy-sign-docker-image == 'true' }}
        uses: sigstore/cosign-installer@main

      - name: Write signing key to disk (only needed for `cosign sign --key`)
        if: ${{ needs.config.outputs.deploy-sign-docker-image == 'true' }}
        continue-on-error: true
        run: echo "${{ secrets.SIGNING_SECRET }}" > cosign.key

      - name: Sign the published Docker image
        if: ${{ needs.config.outputs.deploy-sign-docker-image == 'true' }}
        continue-on-error: true
        env:
          COSIGN_PASSWORD: ""
          VERSION: "${{ needs.release.outputs.version }}"
        run: make sign-ubuntu-image

      - name: Container scan
        uses: aquasecurity/trivy-action@0.8.0
        env:
          image-ref: "${{ steps.docker-meta.outputs.image-id }}:${{ steps.docker-meta.outputs.image-version }}"
        with:
          image-ref: "${{ env.image-ref }}"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"
